<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>三角洲翻牌游戏</title>
  <!-- 1. 引入新的字体和图标库 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    body {
      /* 使用新字体 */
      font-family: 'Poppins', 'Arial', sans-serif;
      color: #3D2C8D;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
      box-sizing: border-box;
      background: linear-gradient(135deg, #63D4D1, #5D3587, #AD88C6, #E8C5E5);
      background-size: 400% 400%;
      animation: moveGradient 15s ease-in-out infinite;
    }

    @keyframes moveGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .game-title { font-size: 2.5rem; color: #fff; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.25); letter-spacing: 3px; margin-bottom: 15px; }
    .mode-selector { margin-bottom: 15px; display: flex; justify-content: center; gap: 10px; }
    .mode-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); color: #fff; padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: all 0.3s; }
    .mode-btn.active { background: #fff; color: #5D3587; font-weight: bold; box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
    .main-controls, .io-controls { margin-bottom: 20px; display: flex; justify-content: center; gap: 15px; }
    .main-btn { background: linear-gradient(to bottom, #AD88C6, #86469C); color: #fff; border: none; padding: 10px 25px; font-size: 1rem; border-radius: 50px; cursor: pointer; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
    .main-btn:hover { transform: scale(1.05); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25); }
    #pause-btn { background: linear-gradient(to bottom, #E8C5E5, #C499F3); }
    #import-input { display: none; }
    .stats-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; font-size: 1.2rem; }
    .stat-box { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px); border-radius: 12px; padding: 10px 20px; min-width: 140px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .game-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; max-width: 800px; margin: 0 auto; padding: 20px; min-height: 100px; }
    
    /* 2. 开场发牌动画 */
    @keyframes dealIn {
      from { transform: scale(0) rotateY(-180deg); opacity: 0; }
      to { transform: scale(1) rotateY(0deg); opacity: 1; }
    }
    .card {
      aspect-ratio: 3 / 4;
      perspective: 1000px;
      cursor: pointer;
      /* 应用发牌动画 */
      animation: dealIn 0.5s ease-out backwards;
    }
    /* 3. 3D悬停效果 */
    .card:not(.flipped):hover {
      transform: translateY(-10px) rotateX(10deg) rotateY(5deg);
      box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
    }
    .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s, box-shadow 0.3s; transform-style: preserve-3d; }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    .card-back { background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; color: rgba(255, 255, 255, 0.8); text-shadow: 0 0 8px rgba(0, 0, 0, 0.2); }
    .card-front { background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3); transform: rotateY(180deg); flex-direction: column; }
    .symbol { width: 70%; height: 60%; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.3); background: rgba(0, 0, 0, 0.1); }
    .symbol img { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; }
    /* 4. 配对成功动画 */
    @keyframes pulseGold {
      0% { box-shadow: 0 0 15px gold, inset 0 0 10px rgba(255, 215, 0, 0.5); }
      50% { box-shadow: 0 0 35px gold, inset 0 0 20px rgba(255, 215, 0, 1); }
      100% { box-shadow: 0 0 15px gold, inset 0 0 10px rgba(255, 215, 0, 0.5); }
    }
    .matched .symbol {
      border-color: gold;
      animation: pulseGold 0.6s ease-in-out;
    }
    .type-label { color: #fff; font-weight: bold; margin-top: 10px; font-size: 1.1rem; letter-spacing: 1px; text-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .results-container { opacity: 0; transform: translateY(20px); max-height: 0; overflow: hidden; transition: all 0.6s ease-out; margin: 0 auto; padding: 0 20px; box-sizing: border-box; }
    .results-container.active { opacity: 1; transform: translateY(0); max-height: 500px; margin-top: 20px; }
    .results-content { background: rgba(255, 255, 255, 0.25); border: 1px solid rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); margin: 0 auto; }
    h2 { color: #fff; }
    #records-container { margin: 40px auto 0; max-width: 600px; }
    #records-list { list-style: none; padding: 0; }
    #records-list li { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .record-actions button { margin-left: 10px; padding: 5px 10px; font-size: 0.9rem; }
    /* 5. 记录列表图标按钮样式 */
    .icon-btn { background: rgba(255, 255, 255, 0.3); color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 1rem; cursor: pointer; transition: all 0.3s; }
    .icon-btn:hover { background: #fff; color: #5D3587; }
    @media (max-width: 600px) { body { padding: 10px; } .game-title { font-size: 2rem; } .stats-container { gap: 10px; } .stat-box { min-width: 120px; padding: 8px 15px; font-size: 1rem; } .game-container { grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px 0; } #records-list li { flex-direction: column; gap: 10px; } .card-back { font-size: 2.5rem; } }
  </style>
</head>
<body>
  <h1 class="game-title">三角洲</h1>
  
  <div class="mode-selector">
    <button class="mode-btn" id="set-low-value-btn">基础版</button>
    <button class="mode-btn" id="set-high-value-btn">进阶版</button>
  </div>

  <div class="main-controls">
    <button class="main-btn" id="new-game-btn">开启新局</button>
    <button class="main-btn" id="pause-btn">暂停游戏</button>
  </div>
  
  <div class="io-controls">
    <button class="main-btn" id="export-btn">保存游戏</button>
    <label for="import-input" class="main-btn">加载对局</label>
    <input type="file" id="import-input" accept=".json,text/plain">
  </div>

  <div class="stats-container">
    <div class="stat-box"><div>翻牌次数</div><div id="moves-count">0</div></div>
    <div class="stat-box"><div>配对成功</div><div id="matches-count">0</div></div>
    <div class="stat-box"><div>前6次内配对</div><div id="early-matches-count">0</div></div>
  </div>
  
  <div class="game-container" id="game-board"></div>

  <div class="results-container" id="results-container">
    <div class="results-content">
      <h2>游戏结束</h2>
      <p>总翻牌次数 <span id="final-moves">0</span></p>
      <p>配对成功 <span id="final-matches">0</span></p>
      <button class="main-btn" id="restart-btn">返回主菜单</button>
    </div>
  </div>

  <div id="records-container">
    <h2>暂停记录</h2>
    <ul id="records-list"></ul>
  </div>
  
  <!-- 6. 添加音效元素 -->
  <audio id="sound-flip" src="sounds/flip.mp3" preload="auto"></audio>
  <audio id="sound-match" src="sounds/match.mp3" preload="auto"></audio>
  <audio id="sound-click" src="sounds/click.mp3" preload="auto"></audio>

<script>
  const imagePaths = { low: '三角洲低价值红色物品图片/', high: '三角洲高价值红色物品图片/' };
  const imageCounts = { low: 36, high: 14 };
  const cardTypes = ['A', 'A', 'B', 'B', 'C', 'C', 'D', 'E', 'F', 'G'];
  const romanNumerals = { A: 'Ⅰ', B: 'Ⅱ', C: 'Ⅲ', D: 'Ⅳ', E: 'Ⅴ', F: 'Ⅵ', G: 'Ⅶ' };
  const SAVES_LS_KEY = 'deltaGameSaves';
  const MODE_LS_KEY = 'deltaGameValueMode';

  let gameState = {};
  let currentValueMode = 'low';

  const gameBoard = document.getElementById('game-board');
  const movesCount = document.getElementById('moves-count');
  const matchesCount = document.getElementById('matches-count');
  const earlyMatchesCount = document.getElementById('early-matches-count');
  const resultsContainer = document.getElementById('results-container');
  const finalMoves = document.getElementById('final-moves');
  const finalMatches = document.getElementById('final-matches');
  const newGameBtn = document.getElementById('new-game-btn');
  const pauseBtn = document.getElementById('pause-btn');
  const restartBtn = document.getElementById('restart-btn');
  const recordsList = document.getElementById('records-list');
  const setLowValueBtn = document.getElementById('set-low-value-btn');
  const setHighValueBtn = document.getElementById('set-high-value-btn');
  const exportBtn = document.getElementById('export-btn');
  const importInput = document.getElementById('import-input');
  
  // 7. 获取音效元素
  const soundFlip = document.getElementById('sound-flip');
  const soundMatch = document.getElementById('sound-match');
  const soundClick = document.getElementById('sound-click');
  
  // 8. 创建一个统一的播放声音函数
  function playSound(sound) {
      sound.currentTime = 0; // 允许快速连续播放
      sound.play().catch(e => console.log("音效播放被浏览器阻止:", e));
  }

  function importSaves(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        if (!Array.isArray(importedData)) { throw new Error('导入的文件格式不正确。'); }
        localStorage.setItem(SAVES_LS_KEY, JSON.stringify(importedData));
        renderRecords();
        alert(`存档已成功恢复！共导入 ${importedData.length} 条记录。`);
      } catch (error) {
        alert('加载失败！请确保文件有效。\n错误: ' + error.message);
      } finally {
        event.target.value = '';
      }
    };
    reader.readAsText(file);
  }
  
  function exportSaves() {
    const saves = localStorage.getItem(SAVES_LS_KEY);
    if (!saves || saves === '[]') {
      alert('没有可保存的记录！');
      return;
    }
    const blob = new Blob([saves], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `delta-game-saves-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function renderRecords() {
    recordsList.innerHTML = '';
    const saves = JSON.parse(localStorage.getItem(SAVES_LS_KEY) || '[]');
    if (saves.length === 0) {
        recordsList.innerHTML = '<li>暂无记录</li>';
        return;
    }
    saves.forEach(save => {
      const li = document.createElement('li');
      const saveDate = new Date(save.id).toLocaleString();
      const modeText = save.valueMode === 'high' ? '进阶版' : '基础版';
      li.innerHTML = `
        <span>[${modeText}] 暂停于: ${saveDate} (翻牌${save.moves}次)</span>
        <div class="record-actions">
          <!-- 9. 使用图标代替文字 -->
          <button class="icon-btn" data-action="load" data-id="${save.id}" title="继续游戏"><i class="fa-solid fa-play"></i></button>
          <button class="icon-btn" data-action="delete" data-id="${save.id}" title="删除记录"><i class="fa-solid fa-trash-can"></i></button>
        </div>
      `;
      recordsList.appendChild(li);
    });
  }
  
  function renderBoard() {
      gameBoard.innerHTML = '';
      if (!gameState.inProgress) return;
      gameState.shuffled.forEach((type, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.type = type;
        card.dataset.index = index;
        
        // 10. 为发牌动画设置延迟
        card.style.animationDelay = `${index * 50}ms`;

        if (gameState.flippedCards.has(index)) card.classList.add('flipped');
        if (gameState.matchedCards.has(index)) card.classList.add('matched');
        const imgSrc = gameState.customImages[type] || '';
        card.innerHTML = `<div class="card-inner"><div class="card-face card-back">${index + 1}</div><div class="card-face card-front"><div class="symbol"><img src="${imgSrc}" alt="Card ${type}" /></div><div class="type-label">${romanNumerals[type]}</div></div></div>`;
        card.addEventListener('click', () => flipCard(card));
        gameBoard.appendChild(card);
      });
  }

  function flipCard(card) {
    const index = parseInt(card.dataset.index);
    if (!gameState.inProgress || gameState.flippedCards.has(index) || gameState.gameComplete) return;
    
    playSound(soundFlip); // 播放翻牌音效
    
    card.classList.add('flipped');
    gameState.moves++;
    gameState.flippedCards.add(index);
    updateStatsUI();
    // 延迟检查匹配，让翻牌动画播完
    setTimeout(() => {
        checkMatches();
        checkGameComplete();
    }, 300);
  }
  
  function checkMatches() {
    const flippedCardsIndexes = [...gameState.flippedCards].filter(index => !gameState.matchedCards.has(index));
    const typeMap = new Map();
    flippedCardsIndexes.forEach(index => {
      const card = gameBoard.querySelector(`[data-index='${index}']`);
      if (card) {
        const type = card.dataset.type;
        if (!typeMap.has(type)) typeMap.set(type, []);
        typeMap.get(type).push(card);
      }
    });
    let newMatches = 0;
    typeMap.forEach((cards, type) => {
      if (['A', 'B', 'C'].includes(type) && cards.length === 2) {
        playSound(soundMatch); // 播放配对成功音效
        cards.forEach(card => {
          card.classList.add('matched');
          gameState.matchedCards.add(parseInt(card.dataset.index));
        });
        newMatches++;
      }
    });
    if (newMatches > 0) {
      gameState.matchedPairs += newMatches;
      if (gameState.moves <= 6) { gameState.earlyMatches += newMatches; }
      updateStatsUI();
    }
  }

  // --- 其他函数 ---
  function setMode(newMode) { playSound(soundClick); currentValueMode = newMode; localStorage.setItem(MODE_LS_KEY, newMode); setLowValueBtn.classList.toggle('active', newMode === 'low'); setHighValueBtn.classList.toggle('active', newMode === 'high'); }
  function resetGameState() { gameState = { id: Date.now(), moves: 0, matchedPairs: 0, earlyMatches: 0, flippedCards: new Set(), matchedCards: new Set(), gameComplete: false, inProgress: false, shuffled: [], customImages: {}, valueMode: currentValueMode }; }
  function initGame() { playSound(soundClick); resetGameState(); gameState.inProgress = true; const basePath = imagePaths[currentValueMode]; const currentImageCount = imageCounts[currentValueMode]; const allImageIndexes = Array.from({ length: currentImageCount }, (_, i) => i + 1); const selectedImages = getRandomSample(allImageIndexes, 7); gameState.customImages = { A: `${basePath}${selectedImages[0]}.png`, B: `${basePath}${selectedImages[1]}.png`, C: `${basePath}${selectedImages[2]}.png`, D: `${basePath}${selectedImages[3]}.png`, E: `${basePath}${selectedImages[4]}.png`, F: `${basePath}${selectedImages[5]}.png`, G: `${basePath}${selectedImages[6]}.png`, }; gameState.shuffled = [...cardTypes].sort(() => Math.random() - 0.5); renderBoard(); updateStatsUI(); resultsContainer.classList.remove('active'); }
  function loadGame(saveId) { playSound(soundClick); const saves = JSON.parse(localStorage.getItem(SAVES_LS_KEY) || '[]'); const saveData = saves.find(s => s.id === saveId); if (saveData) { gameState = JSON.parse(JSON.stringify(saveData)); gameState.flippedCards = new Set(gameState.flippedCards); gameState.matchedCards = new Set(gameState.matchedCards); gameState.inProgress = true; setMode(gameState.valueMode); renderBoard(); updateStatsUI(); resultsContainer.classList.remove('active'); } }
  function saveGame() { playSound(soundClick); if (!gameState.inProgress || gameState.gameComplete) { alert("没有正在进行的游戏可以暂停！"); return; } const saves = JSON.parse(localStorage.getItem(SAVES_LS_KEY) || '[]'); const saveData = { ...gameState, flippedCards: [...gameState.flippedCards], matchedCards: [...gameState.matchedCards] }; saves.push(saveData); localStorage.setItem(SAVES_LS_KEY, JSON.stringify(saves)); alert('游戏已暂停并保存！'); initGame(); renderRecords(); }
  function updateStatsUI() { movesCount.textContent = gameState.moves; matchesCount.textContent = gameState.matchedPairs; earlyMatchesCount.textContent = gameState.earlyMatches; }
  function deleteRecord(saveId) { playSound(soundClick); let saves = JSON.parse(localStorage.getItem(SAVES_LS_KEY) || '[]'); saves = saves.filter(s => s.id !== saveId); localStorage.setItem(SAVES_LS_KEY, JSON.stringify(saves)); renderRecords(); }
  function checkGameComplete() { if (gameState.shuffled.length > 0 && gameState.flippedCards.size === gameState.shuffled.length) { gameState.gameComplete = true; gameState.inProgress = false; finalMoves.textContent = gameState.moves; finalMatches.textContent = gameState.matchedPairs; resultsContainer.classList.add('active'); } }
  function getRandomSample(arr, n) { const result = []; const copied = arr.slice(); for (let i = 0; i < n; i++) { if (copied.length === 0) break; const idx = Math.floor(Math.random() * copied.length); result.push(copied[idx]); copied.splice(idx, 1); } return result; }

  newGameBtn.addEventListener('click', initGame);
  pauseBtn.addEventListener('click', saveGame);
  restartBtn.addEventListener('click', () => { playSound(soundClick); resultsContainer.classList.remove('active'); gameBoard.innerHTML = '<h2>请选择模式，然后点击“开启新局”或从记录继续</h2>'; renderRecords(); });
  setLowValueBtn.addEventListener('click', () => { setMode('low'); });
  setHighValueBtn.addEventListener('click', () => { setMode('high'); });
  recordsList.addEventListener('click', (e) => {
    // 使用 closest 确保点击图标也能触发
    const target = e.target.closest('button');
    if (target) {
      const action = target.dataset.action;
      const id = parseInt(target.dataset.id);
      if (action === 'load') { loadGame(id); deleteRecord(id); }
      else if (action === 'delete') { deleteRecord(id); }
    }
  });
  exportBtn.addEventListener('click', () => { playSound(soundClick); exportSaves(); });
  importInput.addEventListener('change', (e) => { playSound(soundClick); importSaves(e); });

  document.addEventListener('DOMContentLoaded', () => {
    const savedMode = localStorage.getItem(MODE_LS_KEY) || 'low';
    setMode(savedMode);
    gameBoard.innerHTML = '<h2>请选择模式，然后点击“开启新局”或从记录继续</h2>';
    renderRecords();
  });
</script>
</body>
</html>